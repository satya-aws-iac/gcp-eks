# Project Structure â€” gcp-eks

This document describes the repository layout, purpose of key files, and how to run the included helper scripts and workflows.

**Overview**
- Purpose: Provision a GKE cluster (migration from Autopilot to Standard), workflows for Terraform in GitHub Actions, helper scripts to generate/update Terraform files.
- Main folders: `terraform/`, `.github/workflows/`, and top-level helper scripts (`mg.ps1`, `setup-github-oidc.ps1`).

**Top-level files**
- `mg.ps1`: PowerShell helper that creates backups and writes a standard `main.tf`, `variables.tf`, and `outputs.tf` into `terraform/`. It prompts for confirmation and prints manual follow-up steps.
- `setup-github-oidc.ps1`: (optional) helper to configure GitHub OIDC for workload identity (not modified by this change).
- `COMPLETE-SETUP-GUIDE.md`, `workflow.md`: documentation and workflow notes.

**/terraform/**
- `backend.tf`: Terraform remote state backend configuration (locks and stores state remotely).
- `main.tf`: Resource definitions for VPC, Subnetwork, GKE cluster (`google_container_cluster`), node pool (`google_container_node_pool`), and service accounts.
- `variables.tf`: Input variables (project_id, region, zone, cluster_name, environment). `mg.ps1` writes a template here.
- `outputs.tf`: Outputs exported after `apply` (cluster name, endpoint, CA, node details).

Notes about `main.tf` generated by `mg.ps1`:
- The cluster uses `remove_default_node_pool = true` and creates a separate `google_container_node_pool` with `node_count = 2`.
- IP allocation uses secondary ranges for pods and services; `ip_allocation_policy` references `pods` and `services` ranges.
- Workload identity is enabled via `workload_identity_config`.

**/.github/workflows/**
- `terraform-plan.yml`: Runs `terraform init` and `terraform plan` (produces a plan artifact). Ensure secrets are set for GCP creds and `GCP_ZONE`/`GCP_REGION`.
- `terraform-apply.yml`: Applies plan (usually gated with manual approval or only on `stage/main` branches).
- `stage-validation.yml`: Optional pipeline used to validate deployments in a `stage` branch.

**How `mg.ps1` is used (quick)**
1. From repository root run (PowerShell):

```powershell
pwsh -NoProfile -ExecutionPolicy Bypass -File .\mg.ps1
# or
.\mg.ps1
```

2. The script will:
- Confirm you want to proceed
- Create a `backup-<timestamp>/` with copies of `terraform/` and `.github/`
- Overwrite `terraform/main.tf`, `terraform/variables.tf`, and `terraform/outputs.tf` with the recommended standard GKE templates
- Print manual steps (create GitHub secrets, change workflows to use `--zone` vs `--region`, destroy autopilot cluster first)

3. After running, review changes with `git diff` and commit.

**Manual steps required after running `mg.ps1`**
- Add GitHub secret `GCP_ZONE` with a value like `us-central1-a`.
- Replace `--region` with `--zone` in workflows where appropriate, and use `-var="zone=${{ secrets.GCP_ZONE }}"`.
- If you have an Autopilot cluster, run Terraform destroy for that cluster/workflow before provisioning Standard GKE.

**Secrets and GitHub Actions**
- At minimum, configure: `GCP_CREDENTIALS` (service account json), `GCP_PROJECT`, `GCP_REGION` or `GCP_ZONE` depending on workflows.

**Recommended local checks**
- `terraform init` in `/terraform` after setting backend/secrets
- `terraform plan -var="project_id=<project>" -var="zone=<zone>"`

**Next steps for uploading documentation/diagram to GitHub**
- Commit the `docs/` folder and push to your remote branch (e.g., `stage`).
- GitHub will render the Mermaid diagram directly in Markdown files that include it (or view `docs/architecture.mmd` raw if needed).

**Troubleshooting**
- If `mg.ps1` fails due to execution policy, run PowerShell as admin and set `Set-ExecutionPolicy RemoteSigned -Scope CurrentUser` or run with `-ExecutionPolicy Bypass` as shown above.
- Ensure `git` is on the PATH when running `mg.ps1`.

---

If you want, I can also:
- Convert the Mermaid diagram into a PNG/SVG and add it (requires a renderer or mermaid-cli on your machine), or
- Open a PR with these docs committed to `stage` (I can prepare commit commands for you to run).

**Author**

- Name: Mylavarapu Satyanarayana
- Email: mllsatyanarayana@gmail.com
