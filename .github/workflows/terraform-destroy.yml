name: 'Terraform Destroy'

on:
  workflow_dispatch:  # Manual trigger only
    inputs:
      confirm_destroy:
        description: 'Type "destroy" to confirm cluster deletion'
        required: true
        type: string

env:
  TF_VERSION: '1.6.0'
  WORKING_DIR: './terraform'

jobs:
  terraform-destroy:
    name: 'Terraform Destroy'
    runs-on: ubuntu-latest
    environment: production  # GitHub environment for protection rules
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Validate Confirmation
        run: |
          if [ "${{ github.event.inputs.confirm_destroy }}" != "destroy" ]; then
            echo "❌ Destruction cancelled. You must type 'destroy' to proceed."
            exit 1
          fi
          echo "✅ Destruction confirmed - proceeding with cluster deletion"

      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}
          token_format: 'access_token'

      - name: Setup gcloud CLI
        uses: google-github-actions/setup-gcloud@v2

      - name: Terraform Init
        run: terraform init
        working-directory: ${{ env.WORKING_DIR }}

      - name: Terraform Plan Destroy
        id: plan_destroy
        run: |
          terraform plan -destroy -no-color -input=false \
            -var="project_id=${{ secrets.GCP_PROJECT_ID }}" \
            -var="region=${{ secrets.GCP_REGION }}" \
            -var="cluster_name=${{ secrets.GKE_CLUSTER_NAME }}" \
            -out=destroy_plan
        working-directory: ${{ env.WORKING_DIR }}

      - name: Terraform Destroy
        run: terraform destroy -auto-approve destroy_plan
        working-directory: ${{ env.WORKING_DIR }}

      - name: Confirm Cluster Deletion
        run: |
          echo "✅ GKE Cluster '${{ secrets.GKE_CLUSTER_NAME }}' has been destroyed"
          echo "Resources deleted from project: ${{ secrets.GCP_PROJECT_ID }}"

      - name: Create Success Issue
        uses: actions/github-script@v7
        if: success()
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: '✅ GKE Cluster Destroyed',
              body: `## Cluster Destruction Completed
              
              **Cluster**: \`${{ secrets.GKE_CLUSTER_NAME }}\`
              **Project**: \`${{ secrets.GCP_PROJECT_ID }}\`
              **Region**: \`${{ secrets.GCP_REGION }}\`
              
              All Terraform-managed resources have been deleted.
              
              **Workflow Run**: [View Details](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
              
              ⚠️ **Note**: If you have any persistent data (databases, storage buckets) outside of Terraform, they may still exist.
              `,
              labels: ['terraform', 'destroyed']
            });

      - name: Create Failure Issue
        uses: actions/github-script@v7
        if: failure()
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: '❌ GKE Cluster Destruction Failed',
              body: `## Cluster Destruction Failed
              
              **Cluster**: \`${{ secrets.GKE_CLUSTER_NAME }}\`
              **Project**: \`${{ secrets.GCP_PROJECT_ID }}\`
              
              The destruction workflow encountered an error. Please review the logs.
              
              **Workflow Run**: [View Details](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
              
              @${{ github.actor }} - action required to investigate and fix the issue.
              `,
              labels: ['terraform', 'error']
            });
