name: 'Stage Branch Validation'

on:
  push:
    branches:
      - stage
  pull_request:
    branches:
      - stage

env:
  TF_VERSION: '1.6.0'
  WORKING_DIR: './terraform'

jobs:
  validate-and-plan:
    name: 'Validate & Plan (Stage)'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud CLI
        uses: google-github-actions/setup-gcloud@v2

      - name: Terraform Format Check
        id: fmt
        run: |
          terraform fmt -check -recursive
          if [ $? -ne 0 ]; then
            echo "‚ùå Terraform files are not formatted correctly"
            echo "Run: terraform fmt -recursive"
            exit 1
          fi
          echo "‚úÖ Terraform formatting is correct"
        working-directory: ${{ env.WORKING_DIR }}

      - name: Terraform Init
        id: init
        run: terraform init
        working-directory: ${{ env.WORKING_DIR }}

      - name: Terraform Validate
        id: validate
        run: |
          terraform validate -no-color
          if [ $? -eq 0 ]; then
            echo "‚úÖ Terraform configuration is valid"
          else
            echo "‚ùå Terraform configuration has errors"
            exit 1
          fi
        working-directory: ${{ env.WORKING_DIR }}

      - name: Terraform Plan
        id: plan
        run: |
          terraform plan -no-color -input=false \
            -var="project_id=${{ secrets.GCP_PROJECT_ID }}" \
            -var="region=${{ secrets.GCP_REGION }}" \
            -var="cluster_name=${{ secrets.GKE_CLUSTER_NAME }}" \
            -out=tfplan
        working-directory: ${{ env.WORKING_DIR }}

      - name: Upload Plan
        uses: actions/upload-artifact@v4
        with:
          name: stage-terraform-plan-${{ github.sha }}
          path: terraform/plan_output.txt
          retention-days: 30

      - name: Security Scan (checkov)
        id: checkov
        continue-on-error: true
        run: |
          pip install checkov
          checkov -d ${{ env.WORKING_DIR }} --compact --quiet || true

      - name: Generate Summary
        uses: actions/github-script@v7
        env:
          ADDITIONS: ${{ steps.analyze.outputs.additions }}
          CHANGES: ${{ steps.analyze.outputs.changes }}
          DESTRUCTIONS: ${{ steps.analyze.outputs.destructions }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const planOutput = fs.readFileSync('terraform/plan_output.txt', 'utf8');
            
            const summary = `## üîç Stage Branch Validation Report
            
            ### Branch Information
            - **Branch**: \`stage\`
            - **Commit**: \`${{ github.sha }}\`
            - **Author**: @${{ github.actor }}
            - **Timestamp**: ${new Date().toISOString()}
            
            ### Validation Results
            | Check | Status |
            |-------|--------|
            | Format | ${{ steps.fmt.outcome == 'success' ? '‚úÖ' : '‚ùå' }} |
            | Init | ${{ steps.init.outcome == 'success' ? '‚úÖ' : '‚ùå' }} |
            | Validate | ${{ steps.validate.outcome == 'success' ? '‚úÖ' : '‚ùå' }} |
            | Plan | ${{ steps.plan.outcome == 'success' ? '‚úÖ' : '‚ùå' }} |
            | Security Scan | ${{ steps.checkov.outcome == 'success' ? '‚úÖ' : '‚ö†Ô∏è' }} |
            
            ### üìä Planned Changes
            - üÜï **To Add**: ${process.env.ADDITIONS} resources
            - üîÑ **To Change**: ${process.env.CHANGES} resources
            - üóëÔ∏è **To Destroy**: ${process.env.DESTRUCTIONS} resources
            
            <details><summary>üìã View Full Terraform Plan</summary>
            
            \`\`\`terraform
            ${planOutput.substring(0, 50000)}
            \`\`\`
            
            </details>
            
            ### üöÄ Ready to Apply?
            
            **To apply these changes:**
            1. Review the plan above carefully
            2. Create a PR: \`stage\` ‚Üí \`main\`
            3. Get approval from team members
            4. Merge PR to trigger automatic apply
            
            **Or manually apply:**
            \`\`\`bash
            # Merge stage to main
            git checkout main
            git merge stage
            git push origin main
            \`\`\`
            
            [View Workflow Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            `;
            
            await core.summary.addRaw(summary).write();

      - name: Notify on Destructive Changes
        if: steps.analyze.outputs.destructions > 0
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            core.warning(`‚ö†Ô∏è WARNING: This plan will DESTROY ${process.env.DESTRUCTIONS} resources!`);
            
            const comment = `## ‚ö†Ô∏è DESTRUCTIVE CHANGES DETECTED
            
            This Terraform plan will **destroy ${process.env.DESTRUCTIONS} resource(s)**.
            
            Please review carefully before applying to production!
            
            @${{ github.actor }} - ensure this is intentional.
            `;
            
            // Post comment if this is a PR
            if (context.payload.pull_request) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: comment
              });
            }

  cost-estimate:
    name: 'Cost Estimation'
    runs-on: ubuntu-latest
    needs: validate-and-plan
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Download Plan
        uses: actions/download-artifact@v4
        with:
          name: stage-terraform-plan-${{ github.sha }}
          path: ./

      - name: Estimate Costs
        run: |
          echo "### üí∞ Estimated Monthly Costs"
          echo ""
          echo "**GKE Autopilot Cluster:**"
          echo "- Base: ~\$10-30/month (depends on pod usage)"
          echo "- Network egress: ~\$0.12/GB"
          echo "- Storage: ~\$0.17/GB-month"
          echo ""
          echo "**Tips to reduce costs:**"
          echo "- Use Autopilot mode (you're already using it! ‚úÖ)"
          echo "- Minimize persistent volumes"
          echo "- Use proper resource requests/limits"
          echo "- Clean up unused resources regularly"
          echo ""
          echo "[GCP Pricing Calculator](https://cloud.google.com/products/calculator)"